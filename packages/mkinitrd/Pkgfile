# Description: Initrd generator for januslinux
# URL:         https://januslinux.github.io/
# Maintainer:  nee-san, nagakamira at gmail dot com
# Depends on:  kmod cpio pigz

name=mkinitrd
version=20190303
busyboxver=1.30.1
release=1
source=("https://busybox.net/downloads/busybox-$busyboxver.tar.bz2")
BOOTSTRAP=yes

build() {
	echo "Installing mkinitrd"

	DATA="/usr/share/mkinitrd"
	BINDIR="/usr/bin"

	mkdir -p "$PKG"/$DATA/bins "$PKG"/$BINDIR

	install -Dm755 "$STUFF"/mkinitrd/mkinitrd "$PKG"/$BINDIR/mkinitrd
	install -Dm755 "$STUFF"/mkinitrd/init "$PKG"/$DATA/init

	export CFLAGS="$CFLAGS --static -static"
	export CXXFLAGS="$CFLAGS"

	cd "$SRC"/busybox-$busyboxver
	make mrproper

	if [ "$CROSS" = "yes" ]; then
		make ARCH=$XKARCH CROSS_COMPILE=${CROSS_COMPILE} CONFIG_STATIC=y defconfig
	else
		make ARCH=$XKARCH CONFIG_STATIC=y defconfig
	fi

	if [ "$CROSS" = "yes" ]; then
		make ARCH=$XKARCH CROSS_COMPILE=${CROSS_COMPILE} CONFIG_STATIC=y
	else
		make ARCH=$XKARCH CONFIG_STATIC=y
	fi

	chmod +x busybox
	cp busybox "$PKG"/$DATA/bins
}

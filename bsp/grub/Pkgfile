# Description: The GNU GRand Unified Bootloader
# URL:         https://www.gnu.org/software/grub/
# Maintainer:  nee-san, nagakamira at gmail dot com
# Depends on:  gettext-tiny xz lvm2 python

name=grub
version=2.02
release=2
source=("http://ftp.gnu.org/gnu/$name/$name-$version.tar.xz")
BOOTSTRAP=yes

build() {
	unset CXXFLAGS LDFLAGS

	export CFLAGS="${CFLAGS/-D_FORTIFY_SOURCE=2/}"
	export CFLAGS="${CFLAGS/ -fstack-protector-strong/}"
	export CFLAGS="${CFLAGS/ -Wl,-z,relro,-z,now/}"
	export CXXFLAGS="$CFLAGS"

	case $BARCH in
		x86_64|i686|ppc64le|ppc64|ppc)
			true
			;;
		*)
			echo "GRUB is not supported for your architecture"
			exit 1
	esac

	case "$BARCH" in
		x86_64|i686)	EFICONFIG="--disable-efiemu"	;;
	esac

	cd "$SRC"/$name-$version
	patch -Np1 -i "$STUFF"/grub/0004-add-GRUB_COLOR_variables.patch
	patch -Np1 -i "$STUFF"/grub/0005-Allow_GRUB_to_mount_ext234_filesystems_that_have_the_encryption_feature.patch
	patch -Np1 -i "$STUFF"/grub/0006-tsc-Change-default-tsc-calibration-method-to-pmtimer-on-EFI-systems.patch
	patch -Np1 -i "$STUFF"/grub/0007-grub-mkconfig_10_linux_Support_multiple_early_initrd_images.patch
	patch -Np1 -i "$STUFF"/grub/0008-Fix-packed-not-aligned-error-on-GCC-8.patch
	patch -Np1 -i "$STUFF"/grub/0009-xfs-Accept-filesystem-with-sparse-inodes.patch
	patch -Np1 -i "$STUFF"/grub/0010-relocation.patch
	patch -Np1 -i "$STUFF"/grub/0011-f2fs-support.patch
	patch -Np1 -i "$STUFF"/grub/0012-fix-gcc-no-pie-specs.patch
	sed 's|/usr/share/fonts/dejavu|/usr/share/fonts/dejavu /usr/share/fonts/TTF|g' -i configure.ac
	sed 's| ro | rw |g' -i util/grub.d/10_linux.in
	sed 's|GNU/Linux||' -i util/grub.d/10_linux.in

	./autogen.sh
	./configure $TOOLFLAGS $EFICONFIG \
		--prefix=/usr \
		--bindir=/usr/bin \
		--sbindir=/usr/bin \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--datarootdir=/usr/share \
		--sysconfdir=/etc \
		--enable-boot-time \
		--enable-device-mapper \
		--disable-nls \
		--disable-werror
	make
	make DESTDIR="$PKG" bashcompletiondir=/usr/share/bash-completion/completions install

	install -D -m0644 "$STUFF"/grub/default "$PKG"/etc/default/grub
}
